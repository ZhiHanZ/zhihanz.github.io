---
import { getCollection, render } from 'astro:content'
import BaseLayout from '../../layouts/BaseLayout.astro'
import Giscus from '../../components/Giscus.astro'
import { formatDate, loadSite } from '../../lib/site'

export async function getStaticPaths() {
  const series = await getCollection('series')
  return series.map((post) => ({
    params: { slug: post.id },
    props: { post }
  }))
}

const site = loadSite()
const { post } = Astro.props
const { Content } = await render(post)
const { full: publishedAt } = formatDate(post.data.date)
const postUrl = `${site.baseURL}/series/${post.id}/`
const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(postUrl)}`

// Get other parts in the same series
const allSeries = await getCollection('series')
const seriesParts = allSeries
  .filter(p => p.data.series === post.data.series)
  .sort((a, b) => a.data.part - b.data.part)
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article class="container">
    <header class="pb-4 mb-8 border-b border-gray-200">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-sm text-[--color-accent] mb-1">
            {post.data.series} &middot; Part {post.data.part}
          </div>
          <h1 class="text-3xl font-bold mb-2">{post.data.title}</h1>
        </div>
        <a
          href={shareUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="text-gray-400 hover:text-[--color-accent] transition-colors p-1"
          aria-label="Share this post"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
          </svg>
        </a>
      </div>
      <div class="text-sm text-gray-600">
        <time datetime={post.data.date.toISOString()}>{publishedAt}</time>
      </div>
      {post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-3">
          {post.data.tags.map((tag) => (
            <a href={`/tags/${tag}/`} class="tag">{tag}</a>
          ))}
        </div>
      )}
    </header>

    <div class="prose">
      <Content />
    </div>

    <!-- Series Navigation -->
    {seriesParts.length > 1 && (
      <nav class="mt-10 p-4 bg-gray-100 rounded-lg">
        <h3 class="font-semibold mb-3">Series: {post.data.series}</h3>
        <ol class="space-y-2 text-sm">
          {seriesParts.map((part) => (
            <li class={part.id === post.id ? 'text-[--color-accent] font-medium' : ''}>
              <span class="mr-2">Part {part.data.part}:</span>
              {part.id === post.id ? (
                <span>{part.data.title} (current)</span>
              ) : (
                <a href={`/series/${part.id}/`} class="hover:text-[--color-accent]">
                  {part.data.title}
                </a>
              )}
            </li>
          ))}
        </ol>
      </nav>
    )}

    <hr class="border-gray-200 mt-10 mb-4" />
    <Giscus />
  </article>
</BaseLayout>
